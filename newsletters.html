<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WTPO 1760 — Newsletter & Letters Search</title>
  <!-- Tailwind (cdn) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Icons/Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style> body{font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial} mark{background:#fef3c7} </style>
  <!-- Lunr.js (client-side full‑text search) -->
  <script src="https://unpkg.com/lunr/lunr.js"></script>
</head>
<body class="bg-slate-50 text-slate-900">
  <header class="max-w-5xl mx-auto px-4 pt-10 pb-4">
    <h1 class="text-3xl font-bold tracking-tight">WTPO 1760 — Newsletter & Letters Search</h1>
    <p class="text-slate-600 mt-1">Browse, filter, and full‑text search McNulty newsletters, tenant letters, and related notices.</p>
  </header>

  <main class="max-w-5xl mx-auto px-4 pb-24">
    <!-- Controls -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-3 items-end bg-white p-4 rounded-2xl shadow-sm border">
      <label class="md:col-span-2">
        <span class="block text-sm font-semibold">Search text</span>
        <input id="q" type="search" placeholder="title, quotes, claims, topics…" class="w-full px-3 py-2 rounded-xl border focus:outline-none focus:ring-2 focus:ring-emerald-400" />
      </label>
      <label>
        <span class="block text-sm font-semibold">Year</span>
        <select id="year" class="w-full px-3 py-2 rounded-xl border bg-white">
          <option value="">All</option>
        </select>
      </label>
      <label>
        <span class="block text-sm font-semibold">Tag</span>
        <select id="tag" class="w-full px-3 py-2 rounded-xl border bg-white">
          <option value="">All</option>
        </select>
      </label>
      <div class="md:col-span-4 flex flex-wrap gap-3 items-center">
        <label class="flex items-center gap-2 text-sm"><input id="only-newsletters" type="checkbox" class="rounded"> <span>Only newsletters/tenant letters</span></label>
        <label class="flex items-center gap-2 text-sm"><input id="only-context" type="checkbox" class="rounded"> <span>Only context (bylaws, emails, filings)</span></label>
        <div class="ml-auto flex gap-2">
          <button id="clear" class="px-3 py-2 rounded-xl bg-slate-200 hover:bg-slate-300 text-sm">Clear</button>
          <select id="sort" class="px-3 py-2 rounded-xl border bg-white text-sm">
            <option value="date-desc">Newest first</option>
            <option value="date-asc">Oldest first</option>
            <option value="title-asc">Title A→Z</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Counts -->
    <div id="counts" class="text-sm text-slate-600 mt-3"></div>

    <!-- Disclaimer (auto shown when results touch elections/nominations or potential non‑compliance) -->
    <div id="disclaimer" class="hidden mt-3 p-3 rounded-2xl border border-amber-300 bg-amber-50 text-amber-900 text-sm">
      <div class="font-semibold">⚠️ Heads‑up</div>
      <p class="mt-1">One or more results relate to nominations/elections or may reflect conduct that does not comply with established law. Please verify against official requirements, including <strong>24 CFR Part 964</strong> (tenant participation), the <strong>SF Sunshine Ordinance</strong> (Administrative Code Chapter 67), and the <strong>California Brown Act</strong> (Gov. Code §54950 et seq.).</p>
    </div>

    <!-- Results -->
    <div id="results" class="mt-4 grid gap-3"></div>
  </main>

  <template id="card-tpl">
    <article class="bg-white border rounded-2xl shadow-sm p-4">
      <div class="flex flex-wrap items-center gap-x-3 gap-y-2">
        <time class="text-xs font-semibold text-slate-700 bg-slate-100 rounded px-2 py-1"></time>
        <span class="text-xs px-2 py-1 rounded bg-emerald-50 text-emerald-700 font-semibold tag"></span>
        <span class="text-xs px-2 py-1 rounded bg-indigo-50 text-indigo-700 font-semibold kind"></span>
        <span class="hidden text-xs px-2 py-1 rounded bg-amber-100 text-amber-900 font-semibold ml-auto badge-elect"></span>
      </div>
      <h3 class="mt-3 text-lg font-semibold title"></h3>
      <p class="mt-1 text-sm text-slate-700 line-clamp-3 summary"></p>
      <div class="mt-2 hidden text-xs text-red-700 bg-red-50 border border-red-200 rounded-lg p-2 disclaimer-card"></div>
      <div class="mt-3 flex flex-wrap gap-2 attachments"></div>
    </article>
  </template>

  <script>
    // ---- Configuration ----
    const DATA_URL = './newsletters.json';

    // ---- State ----
    let DATA = [];
    let idx; // lunr index

    // ---- Utilities ----
    const fmtDate = (iso) => new Date(iso + 'T00:00:00').toLocaleDateString(undefined, {year:'numeric', month:'short', day:'2-digit'});
    const uniq = (arr) => [...new Set(arr.filter(Boolean))];

    function highlight(text, terms){
      if(!terms || !terms.length || !text) return text||'';
      const esc = (s)=>s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
      const pat = new RegExp('(' + terms.map(esc).join('|') + ')', 'ig');
      return String(text).replace(pat, '<mark>$1</mark>');
    }

    // ---- Compliance flagging ----
    function classify(item){
      const text = [item.title, item.summary, item.body, (item.tags||[]).join(' ')].filter(Boolean).join(' ').toLowerCase();
      const has = (re)=> re.test(text);
      const electionRelated = has(/\b(election|nomination|ballot|quorum|vote|recall)s?\b/);
      const cfr = has(/\b24\s*cfr\b|\bpart\s*964\b|\b964\.\d+/);
      const sunshine = has(/sunshine\s+ordinance|admin(istrative)?\s*code\s*(ch|chapter)?\s*67/);
      const brown = has(/brown\s+act|gov(ernment)?\s*code\s*§?\s*5495\d/);
      const irregular = has(/\b(irregular|violation|non[-\s]?compliance|non[-\s]?compliant|contrary)\b/);

      const statutes = [];
      if(cfr) statutes.push('24 CFR Part 964');
      if(sunshine) statutes.push('SF Sunshine Ordinance (Admin Code Ch. 67)');
      if(brown) statutes.push('California Brown Act (Gov. Code §54950 et seq.)');

      const needsDisclaimer = electionRelated || (statutes.length && (irregular || electionRelated));
      return { electionRelated, statutes, needsDisclaimer };
    }

    // ---- Rendering ----
    function render(list, terms){
      const res = document.getElementById('results');
      res.innerHTML = '';
      const tpl = document.getElementById('card-tpl');

      let anyFlagged = false; let anyStatutes = new Set();

      list.forEach(item => {
        const node = tpl.content.cloneNode(true);
        node.querySelector('time').textContent = fmtDate(item.date);
        node.querySelector('.tag').textContent = item.tags?.[0] || 'untagged';
        node.querySelector('.kind').textContent = item.kind;
        node.querySelector('.title').innerHTML = highlight(item.title, terms);
        node.querySelector('.summary').innerHTML = highlight(item.summary || '', terms);

        // Flags / disclaimer per card
        const flags = classify(item);
        if(flags.needsDisclaimer){
          anyFlagged = true;
          flags.statutes.forEach(s=>anyStatutes.add(s));
          const cardNote = node.querySelector('.disclaimer-card');
          const badge = node.querySelector('.badge-elect');
          badge.classList.remove('hidden');
          badge.textContent = flags.electionRelated ? 'Elections/Nominations' : 'Compliance Notice';
          cardNote.classList.remove('hidden');
          cardNote.innerHTML = '⚠️ This item relates to elections/nominations or cites laws that may be implicated. It may not comply with established requirements. Please verify (e.g., ' +
            (flags.statutes.length? flags.statutes.join('; ') : '24 CFR Part 964; SF Sunshine Ordinance; Brown Act') + ').';
        }

        const att = node.querySelector('.attachments');
        (item.urls||[]).forEach(u => {
          const a = document.createElement('a');
          a.href = u; a.target = '_blank'; a.rel = 'noopener';
          a.className = 'text-xs px-2 py-1 rounded border hover:bg-slate-50';
          a.textContent = new URL(u, location.href).pathname.split('/').pop();
          att.appendChild(a);
        });
        res.appendChild(node);
      });

      // Global disclaimer banner
      const banner = document.getElementById('disclaimer');
      if(anyFlagged){
        banner.classList.remove('hidden');
      }else{
        banner.classList.add('hidden');
      }

      document.getElementById('counts').textContent = `${list.length} item${list.length===1?'':'s'} shown`;
    }

    function populateFilters(){
      const years = uniq(DATA.map(d => d.date?.slice(0,4))).sort();
      const tags = uniq(DATA.flatMap(d => d.tags||[])).sort();
      const yearSel = document.getElementById('year');
      years.forEach(y => { const o = document.createElement('option'); o.value=o.textContent=y; yearSel.appendChild(o); });
      const tagSel = document.getElementById('tag');
      tags.forEach(t => { const o = document.createElement('option'); o.value=o.textContent=t; tagSel.appendChild(o); });
    }

    function applyFilters(query){
      let results = [...DATA];
      const year = document.getElementById('year').value;
      const tag = document.getElementById('tag').value;
      const onlyNews = document.getElementById('only-newsletters').checked;
      const onlyCtx = document.getElementById('only-context').checked;
      const sort = document.getElementById('sort').value;

      if(year) results = results.filter(r => r.date?.startsWith(year));
      if(tag) results = results.filter(r => r.tags?.includes(tag));
      if(onlyNews) results = results.filter(r => r.kind === 'newsletter');
      if(onlyCtx) results = results.filter(r => r.kind !== 'newsletter');

      // Full‑text search via lunr
      let terms = [];
      if(query && idx){
        const hits = idx.search(query);
        const byId = new Map(hits.map(h => [h.ref, h]));
        results = results.filter(r => byId.has(r.id));
        results.sort((a,b)=> byId.get(b.id).score - byId.get(a.id).score);
        terms = query.split(/\s+/).filter(Boolean);
      }

      // secondary sorts
      if(!query){
        const cmp = {
          'date-desc': (a,b)=> (b.date||'').localeCompare(a.date||''),
          'date-asc':  (a,b)=> (a.date||'').localeCompare(b.date||''),
          'title-asc': (a,b)=> (a.title||'').localeCompare(b.title||'')
        }[sort];
        results.sort(cmp);
      }

      render(results, terms);
    }

    function wire(){
      const q = document.getElementById('q');
      const onChange = ()=> applyFilters(q.value.trim());
      q.addEventListener('input', onChange);
      ['year','tag','only-newsletters','only-context','sort'].forEach(id=>{
        document.getElementById(id).addEventListener('change', onChange);
      });
      document.getElementById('clear').addEventListener('click', ()=>{
        q.value=''; ['year','tag','only-newsletters','only-context'].forEach(id=>{ const el=document.getElementById(id); if(el.type==='checkbox') el.checked=false; });
        document.getElementById('year').value=''; document.getElementById('tag').value=''; document.getElementById('sort').value='date-desc';
        applyFilters('');
      });
    }

    function buildIndex(){
      idx = lunr(function(){
        this.ref('id');
        this.field('title');
        this.field('summary');
        this.field('body');
        this.field('tags');
        this.field('kind');
        DATA.forEach(d => this.add(d));
      });
    }

    async function boot(){
      wire();
      try{
        const r = await fetch(DATA_URL, {cache:'no-store'});
        DATA = await r.json();
      }catch(e){
        console.warn('Failed to fetch data file. Using demo sample.', e);
        // minimal demo dataset so page still renders
        DATA = [
          { id:'demo-05152024', kind:'newsletter', date:'2024-05-15', title:'There seems to be a little controversy…', summary:'Letter about timing of elections; nomination/Election dates listed as May 28 & Jun 25.', tags:['elections','schedule','24 CFR 964.130'], urls:[] },
          { id:'demo-05272024', kind:'context', date:'2024-05-27', title:'Board response citing HUD 30‑day notice', summary:'Cites 24 CFR 964.130 for 30‑day nomination/election notice.', tags:['HUD','bylaws','Brown Act'], urls:[] }
        ];
      }
      populateFilters();
      buildIndex();
      applyFilters('');
    }

    boot();
  </script>

  <!--
  =====================
  Data file schema (newsletters.json)
  =====================
  [
    {
      "id": "unique-id",
      "kind": "newsletter" | "context",        // newsletter/letter vs. bylaws/emails/filings
      "date": "YYYY-MM-DD",
      "title": "Display title",
      "summary": "1–3 line summary for quick scanning",
      "tags": ["elections", "bylaws", "RCA", "litigation"],
      "urls": ["/wtp/docs/05252024_AR-reply.pdf", "/wtp/docs/05252024_AR-reply.docx"],
      "body": "(optional) full extracted text to improve search accuracy"
    }
  ]
  -->
</body>
</html>
